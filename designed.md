# ğŸ“ äº§å“æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼šAIå¨±ä¹-å­©å­åƒè° (H5)

## 1. é¡¹ç›®æ¦‚è¿° (Project Overview)

* **äº§å“åç§°ï¼š** AIå¨±ä¹-å­©å­åƒè°
* **äº§å“å½¢æ€ï¼š** ç§»åŠ¨ç«¯é€‚é…çš„ H5 ç½‘é¡µåº”ç”¨ã€‚
* **æ ¸å¿ƒåŠŸèƒ½ï¼š** ç”¨æˆ·è¾“å…¥ä»ç¬¬ä¸‰æ–¹å¹³å°ï¼ˆå°çº¢ä¹¦ï¼‰è´­ä¹°çš„å…‘æ¢ç ï¼Œä¸Šä¼ çˆ¶æ¯ä¸å­©å­çš„ç…§ç‰‡ï¼Œè°ƒç”¨ **Google Gemini Multimodal API** åˆ†æäº”å®˜é—ä¼ ç‰¹å¾ï¼Œå¹¶ç”Ÿæˆå¸¦æœ‰è§†è§‰æ ‡æ³¨çš„åˆ†æå›¾ã€‚
* **å•†ä¸šæ¨¡å¼ï¼š** ç«™å¤–è´­ç  -> ç«™å†…æ ¸é”€ -> AI åˆ†æ -> ç»“æœå±•ç¤ºã€‚

---

## 2. ä¸šåŠ¡æµç¨‹ (Business Flow)

1. **è´­ä¹° (Purchase)ï¼š** ç”¨æˆ·åœ¨å°çº¢ä¹¦åº—é“ºä¸‹å•ï¼ˆ1å…ƒ/æ¬¡ï¼‰ï¼Œé˜¿å¥‡ç´¢è‡ªåŠ¨å‘è´§å·¥å…·å‘é€å”¯ä¸€çš„ **12ä½å…‘æ¢ç **ã€‚
2. **æ¿€æ´» (Redemption)ï¼š** ç”¨æˆ·æ‰“å¼€ H5ï¼Œè¾“å…¥å…‘æ¢ç ã€‚
3. **ç»‘å®š (Binding)ï¼š** åç«¯éªŒè¯ç æœ‰æ•ˆæ€§ï¼Œå¹¶å°†è¯¥ç ä¸å½“å‰ç”¨æˆ·çš„ **è®¾å¤‡æŒ‡çº¹ (Device Fingerprint)** ç»‘å®šã€‚
4. **åˆ†æ (Analysis)ï¼š** ç”¨æˆ·ä¸Šä¼  2-3 å¼ ç…§ç‰‡ï¼Œåç«¯é€ä¼ ç»™ Gemini API è¿›è¡Œå¤šæ¨¡æ€åˆ†æã€‚
5. **äº¤ä»˜ (Delivery)ï¼š** H5 å‰ç«¯æ¥æ”¶ JSON æ•°æ®ï¼Œåœ¨å­©å­ç…§ç‰‡ä¸ŠåŠ¨æ€ç»˜åˆ¶æ ‡æ³¨çº¿å’Œæ–‡æ¡ˆï¼Œç”Ÿæˆç»“æœå›¾ã€‚
6. **ä¿å­˜ (Retention)ï¼š** ç»“æœä»…åœ¨å½“å‰è®¾å¤‡ä¿ç•™ 24 å°æ—¶ï¼Œè¿‡æœŸè‡ªåŠ¨é”€æ¯ã€‚

---

## 3. é¡µé¢äº¤äº’è®¾è®¡ (UI/UX)

### 3.1 é¦–é¡µ (Home Page)

* **è§†è§‰ï¼š** ç§‘æŠ€æ„ŸèƒŒæ™¯ï¼Œå±•ç¤º 2-3 ç»„é«˜è´¨é‡çš„å¯¹æ¯” Demoï¼ˆå·¦ä¾§çˆ¶æ¯ï¼Œå³ä¾§å¸¦æ ‡æ³¨çš„å­©å­ï¼‰ã€‚
* **æ“ä½œåŒºï¼š**
* **è¾“å…¥æ¡†ï¼š** â€œè¯·è¾“å…¥å…‘æ¢ç â€
* **ä¸»æŒ‰é’®ï¼š** [å¼€å§‹ AI åŸºå› æ¢æµ‹]
* **å‹¾é€‰æ¡† (é»˜è®¤æœªå‹¾)ï¼š** â€œæˆ‘å·²é˜…è¯»å¹¶åŒæ„ï¼šæœ¬ç»“æœä»…ä¾›å¨±ä¹ï¼ŒAI åˆ†æå—å…‰çº¿å½±å“ï¼Œæ— æ³•é€€æ¬¾ã€‚â€


* **é€»è¾‘ï¼š**
* é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨æ£€æŸ¥ `LocalStorage` æ˜¯å¦æœ‰æœªè¿‡æœŸçš„è®¢å•ã€‚è‹¥æœ‰ï¼Œæ˜¾ç¤ºâ€œæ£€æµ‹åˆ°æ‚¨æœ‰è¿›è¡Œä¸­çš„åˆ†æâ€ï¼Œæä¾› [æŸ¥çœ‹å†å²ç»“æœ] å…¥å£ã€‚



### 3.2 ä¸Šä¼ é¡µ (Upload Page)

* **æ§½ä½ (Slots)ï¼š**
1. **çˆ¶äº²/æ¯äº² (å¿…å¡«)**ï¼šæ”¯æŒè£å‰ªæˆ–è‡ªåŠ¨ç¼©æ”¾ã€‚
2. **çˆ¶äº²/æ¯äº² (é€‰å¡«)**ï¼šå•äº²å®¶åº­å¯ç•™ç©ºã€‚
3. **å­©å­ (å¿…å¡«)**ï¼šå¿…é¡»ä¸ºæ­£é¢äº”å®˜æ¸…æ™°ç…§ã€‚


* **æç¤ºæ–‡æ¡ˆï¼š** â€œä¸ºä¿è¯ AI è¯†åˆ«å‡†ç¡®ï¼Œè¯·åŠ¡å¿…ä¸Šä¼ **æ­£é¢ã€æ— é®æŒ¡ã€å…‰çº¿å……è¶³**çš„ç…§ç‰‡ã€‚è¯·å‹¿é®æŒ¡çœ‰æ¯›å’Œé¢å¤´ã€‚â€

### 3.3 æ­£åœ¨åˆ†æé¡µ (Loading Page)

* **åŠ¨ç”»ï¼š** åŸºå› é“¾æ—‹è½¬æˆ–é›·è¾¾æ‰«æåŠ¨ç”»ã€‚
* **è½®æ’­æç¤ºï¼š**
* â€œæ­£åœ¨è¿æ¥ Google Gemini å¤§è„‘...â€
* â€œæ­£åœ¨æå–é¢éƒ¨ 106 ä¸ªç‰¹å¾ç‚¹...â€
* â€œæ­£åœ¨æ¯”å¯¹é—ä¼ ç›¸ä¼¼åº¦...â€



### 3.4 ç»“æœé¡µ (Result Page)

* **æ ¸å¿ƒå±•ç¤ºï¼š** ä»¥å­©å­ç…§ç‰‡ä¸ºåº•å›¾ï¼Œè¦†ç›– Canvas ç»˜åˆ¶çš„æ ‡æ³¨å±‚ã€‚
* **æ ‡æ³¨å±‚æ ·å¼ï¼š** ä»äº”å®˜ä¸­å¿ƒç‚¹æ‹‰å‡ºç»†çº¿ï¼Œè¿æ¥åˆ°åŠé€æ˜æ–‡æœ¬æ¡†ã€‚
* **åº•éƒ¨æ“ä½œï¼š**
* [é•¿æŒ‰å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ]
* [å†æµ‹ä¸€æ¬¡]ï¼ˆè·³è½¬å›é¦–é¡µï¼‰
* [ç»“æœä¸å‡†ï¼Ÿ]ï¼ˆå¼¹çª—æç¤ºï¼šå—å…‰çº¿è§’åº¦å½±å“ï¼Œå»ºè®®æ›´æ¢é«˜æ¸…æ­£é¢ç…§é‡è¯•ï¼Œæœ¬æœåŠ¡ä¸æ”¯æŒé€€æ¬¾ï¼‰ã€‚



---

## 4. æŠ€æœ¯æ¶æ„ (Technical Architecture)

* **å‰ç«¯ (Frontend)ï¼š** React 18 / Vue 3 + Tailwind CSS + FingerprintJS (è®¾å¤‡æŒ‡çº¹) + HTML5 Canvas (ç»˜å›¾)ã€‚
* **åç«¯ (Backend)ï¼š** Python (FastAPI) æˆ– Node.js (Koa/Express)ã€‚
* **AI æ¨¡å‹ (Model)ï¼š** Google Gemini 3 Pro (é€šè¿‡ API è°ƒç”¨)ã€‚
* **æ•°æ®åº“ (Database)ï¼š** SQLite (è½»é‡çº§) æˆ– MySQLã€‚
* **å­˜å‚¨ (Storage)ï¼š** ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ï¼ˆæœ¬åœ° `/tmp` æˆ– AWS S3/OSSï¼‰ï¼Œéœ€é…ç½®ç”Ÿå‘½å‘¨æœŸè§„åˆ™ã€‚

---

## 5. æ•°æ®åº“è®¾è®¡ (Database Schema)

**è¡¨åï¼š`card_keys**`

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| --- | --- | --- |
| `id` | Integer | è‡ªå¢ä¸»é”® |
| `code` | String(20) | **å”¯ä¸€ç´¢å¼•**ï¼Œå…‘æ¢ç  |
| `status` | Enum | `0`: æœªä½¿ç”¨, `1`: å·²ä½¿ç”¨ |
| `device_id` | String(64) | ç»‘å®šçš„è®¾å¤‡æŒ‡çº¹ |
| `activated_at` | DateTime | æ¿€æ´»æ—¶é—´ |
| `result_cache` | JSON | (å¯é€‰) ç¼“å­˜ Gemini è¿”å›çš„ JSONï¼Œç”¨äºåˆ·æ–°é‡ç»˜ |
| `image_paths` | JSON | (å¯é€‰) ä¸´æ—¶å›¾ç‰‡è·¯å¾„ï¼Œç”¨äº 24h æ¸…ç†ç´¢å¼• |

---

## 6. æ ¸å¿ƒ AI æç¤ºè¯ (Gemini Prompt)

**Backend System Instruction:**

```markdown
ä½ æ˜¯ä¸€ä½æ‹¥æœ‰ 20 å¹´ç»éªŒçš„äººç±»å­¦ä¸é¢éƒ¨é—ä¼ å­¦ä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æå®¶åº­ç…§ç‰‡ï¼Œé€šè¿‡å¯¹æ¯”çˆ¶æ¯ä¸å­©å­çš„é¢éƒ¨ç‰¹å¾ï¼Œè¯†åˆ«é—ä¼ ç›¸ä¼¼æ€§ã€‚

**ä»»åŠ¡ç›®æ ‡ï¼š**
åˆ†ææä¾›çš„å›¾ç‰‡ï¼ˆçˆ¶äº²ã€æ¯äº²ã€å­©å­ï¼‰ï¼Œé’ˆå¯¹å­©å­çš„ç‰¹å®šäº”å®˜éƒ¨ä½ï¼Œåˆ¤æ–­å…¶ç‰¹å¾æ›´åƒçˆ¶äº²è¿˜æ˜¯æ¯äº²ï¼Œå¹¶è¾“å‡º JSON æ•°æ®ã€‚

**åˆ†æç»´åº¦ï¼ˆä»…åˆ†æä»¥ä¸‹éƒ¨ä½ï¼Œå¿½ç•¥è€³æœµï¼‰ï¼š**
1. **çœ‰æ¯› (Eyebrows)**ï¼šçœ‰å½¢ã€æµ“å¯†ç¨‹åº¦ã€çœ‰å³°ã€‚
2. **çœ¼ç› (Eyes)**ï¼šçœ¼è£‚é•¿åº¦ã€å†…çœ¼è§’å½¢çŠ¶ã€åŒçœ¼çš®ç‰¹å¾ã€‚
3. **é¼»å­ (Nose)**ï¼šé¼»æ¢é«˜åº¦ã€é¼»ç¿¼å®½çª„ã€é¼»å°–å½¢çŠ¶ã€‚
4. **å˜´å·´ (Mouth)**ï¼šå˜´å”‡åšåº¦ã€å”‡å³°å½¢çŠ¶ã€å˜´è§’è¶‹åŠ¿ã€‚
5. **è„¸å‹ (Face Shape)**ï¼šä¸‹é¢Œçº¿æ¡ã€é¢§éª¨å®½åº¦ã€æ•´ä½“è½®å»“ã€‚
6. **å¤´å‹ (Head Shape)**ï¼šé¢…é¡¶é«˜åº¦ã€é¢å¤´å®½åº¦ã€æ•´ä½“åœ†æ¶¦åº¦ã€‚
7. **æ€»ç»“ (Summary)**ï¼šå­©å­æ•´ä½“æ›´åƒè°ã€‚

**è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š**
1. ç›´æ¥è¿”å›çº¯ JSONï¼Œä¸åŒ…å« Markdown æ ‡è®°ã€‚
2. **Coordinate è¯´æ˜ï¼š** è¾“å‡ºè¯¥éƒ¨ä½åœ¨ã€å­©å­ç…§ç‰‡ã€‘ä¸­çš„ä¸­å¿ƒç‚¹ç›¸å¯¹åæ ‡ï¼ˆ0-100ï¼‰ã€‚ä¾‹å¦‚ x:50, y:50 ä»£è¡¨å›¾ç‰‡æ­£ä¸­å¿ƒã€‚
3. **Description é£æ ¼ï¼š** æ¸©é¦¨ã€æœ‰è¶£ä½†å¸¦æœ‰ç§‘å­¦æ„Ÿï¼Œä¸è¶…è¿‡ 15 ä¸ªå­—ã€‚

**JSON ç»“æ„ï¼š**
{
  "analysis_results": [
    {
      "part": "éƒ¨ä½åç§°(ä¸­æ–‡)",
      "similar_to": "Father" æˆ– "Mother",
      "similarity_score": æ•´æ•°(50-99),
      "description": "ç®€çŸ­æè¿°",
      "coordinate": { "x": æ•´æ•°(0-100), "y": æ•´æ•°(0-100) }
    }
  ]
}

```

---

## 7. æ ¸å¿ƒ API æ¥å£å®šä¹‰

### 7.1 éªŒè¯å…‘æ¢ç 

* **URL:** `POST /api/verify_code`
* **Payload:** `{ "code": "ABC12345", "device_id": "fp_x8a9s7d" }`
* **Logic:**
1. æŸ¥åº“ï¼šç æ˜¯å¦å­˜åœ¨ï¼Ÿ
2. è‹¥ `status=0` (æœªä½¿ç”¨)ï¼šæ›´æ–° `status=1`, `device_id=current`, `activated_at=now`ã€‚è¿”å› `Success`ã€‚
3. è‹¥ `status=1` (å·²ä½¿ç”¨)ï¼šæ£€æŸ¥ `device_id` æ˜¯å¦åŒ¹é…ã€‚
* åŒ¹é… -> è¿”å› `Success` (æ¢å¤ä¼šè¯)ã€‚
* ä¸åŒ¹é… -> è¿”å› `Error: æ­¤ç å·²è¢«å…¶ä»–è®¾å¤‡æ¿€æ´»`ã€‚





### 7.2 ä¸Šä¼ ä¸åˆ†æ

* **URL:** `POST /api/analyze`
* **Headers:** `Authorization: Bearer <code_string>` (ç”¨å…‘æ¢ç é‰´æƒ)
* **Body:** `Multipart/Form-Data` (images: [file1, file2, file3])
* **Logic:**
1. æ ¡éªŒ `code` æ˜¯å¦åœ¨ `card_keys` è¡¨ä¸­ä¸” `device_id` åŒ¹é…ã€‚
2. è°ƒç”¨ Gemini APIï¼š
* æ„å»º Promptã€‚
* ä¸Šä¼  Image Blobsã€‚
* è·å– JSON Responseã€‚


3. å°† JSON å­˜å…¥ `card_keys.result_cache` (ç”¨äºåˆ·æ–°æ¢å¤)ã€‚
4. è¿”å› JSON ç»™å‰ç«¯ã€‚



---

## 8. å‰ç«¯ç»˜åˆ¶é€»è¾‘ (Canvas)

ç”±äº Gemini è¿”å›çš„æ˜¯ç›¸å¯¹åæ ‡ `(x%, y%)`ï¼Œå‰ç«¯ä¸éœ€è¦è¿›è¡Œå¤æ‚è®¡ç®—ï¼š

1. **è·å–åº•å›¾å°ºå¯¸ï¼š** `imgWidth`, `imgHeight`ã€‚
2. **éå†ç»“æœæ•°ç»„ï¼š**
```javascript
results.forEach(item => {
  const posX = (item.coordinate.x / 100) * imgWidth;
  const posY = (item.coordinate.y / 100) * imgHeight;

  // 1. ç»˜åˆ¶ä¸­å¿ƒç‚¹æˆ–åœ†åœˆ
  ctx.beginPath();
  ctx.arc(posX, posY, 5, 0, 2 * Math.PI);
  ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
  ctx.fill();

  // 2. ç»˜åˆ¶æŠ˜çº¿è¿æ¥åˆ°æ–‡å­—æ¡† (ç®—æ³•ï¼šåˆ¤æ–­ç‚¹åœ¨å·¦åŠè¾¹è¿˜æ˜¯å³åŠè¾¹ï¼Œå‘ä¸¤ä¾§æ‹‰çº¿)
  const labelX = posX > imgWidth / 2 ? posX + 50 : posX - 150; 
  const labelY = posY - 20;

  // 3. ç»˜åˆ¶æ–‡å­—èƒŒæ™¯å’Œæ–‡å­— (item.part + item.description)
  // ...Canvas ç»˜å›¾ä»£ç 
});

```



---

## 9. éšç§ä¸å®‰å…¨ç­–ç•¥ (Privacy & Security)

1. **æ•°æ®è‡ªåŠ¨æ¸…ç†ï¼š**
* åç«¯è®¾ç½®å®šæ—¶ä»»åŠ¡ (Cron Job)ï¼Œæ¯å°æ—¶è¿è¡Œä¸€æ¬¡ã€‚
* é€»è¾‘ï¼š`DELETE FROM card_keys WHERE activated_at < NOW() - INTERVAL 24 HOUR`ã€‚
* åŒæ—¶åˆ é™¤æœåŠ¡å™¨ä¸´æ—¶æ–‡ä»¶å¤¹ä¸­å¯¹åº”çš„å›¾ç‰‡æ–‡ä»¶ã€‚


2. **å‰ç«¯æç¤ºï¼š**
* åœ¨ç»“æœé¡µåº•éƒ¨æ ‡æ³¨ï¼šâ€œä¸ºä¿æŠ¤æ‚¨çš„éšç§ï¼Œæœ¬é¡µç»“æœä»…åœ¨å½“å‰è®¾å¤‡ä¿ç•™ 24 å°æ—¶ï¼Œè¯·å°½å¿«ä¿å­˜ã€‚â€


3. **é˜²ç™½å«–/é˜²ç›—åˆ·ï¼š**
* åˆ©ç”¨ `Device Fingerprint` å¼ºç»‘å®šå…‘æ¢ç ï¼Œé˜²æ­¢ç”¨æˆ·è´­ä¹°ä¸€ä¸ªç ååˆ†äº«åˆ°ç¾¤é‡Œä¾›å¤šäººä½¿ç”¨ã€‚

